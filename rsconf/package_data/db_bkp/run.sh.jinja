#!/bin/bash
set -euo pipefail

db_bkp_main() {
    local f d u g root
    local date=$(date +%Y%m%d%H%M%S)
    for f in '{{ rsconf_db.host_run_d }}'/*/'{{ db_bkp.script_name }}'; do
        root=$(dirname "$f")
        d="$root/{{ db_bkp.subdir_name }}/$date"
        db_bkp_msg "$d: begin"
        eval $(stat --printf="g='%G' u='%U'" "$f")
        install -m 700 -o "$u" -g "$g"  -d "$d"
        if ! su - "$u" bash -c "cd '$d' && source '$f'"; then
            db_bkp_msg "$d: FAILED"
        fi
        # TODO(robnagler) trim directories
    done
    db_bkp_msg done
}

db_bkp_msg() {
    echo "$@" 1>&2
}

db_bkp_main "$@"
