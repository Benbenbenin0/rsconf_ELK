server {
    listen {{ nginx.vhost }}:80;
    server_name {{ nginx.vhost }};
    return 301 https://$http_host$request_uri;
}

server {
    listen {{ nginx.vhost }}:443 ssl;
    server_name {{ nginx.vhost }};
    root {{ nginx.default_root }};
    ssl_certificate {{ nginx.tls_crt }};
    ssl_certificate_key {{ nginx.tls_key }};
    client_max_body_size {{ bop.client_max_body_size }};
    {{ bop.aux_directives | indent(4, indentfirst=False) }}

    location ~ /_ {
        deny all;
        return 403;
    }

    # Need to configure caching and better proxying
    # https://www.digitalocean.com/community/tutorials/understanding-nginx-http-proxying-load-balancing-buffering-and-caching
    location / {
        allow all;
        proxy_set_header Proxy "";
        # These are the only values used by Bivio::Agent::HTTP::Request
        # better to use $host, not $http_host, because can be empty
        proxy_set_header Host $host;
        # force this, because we don't trust upstream so don't use $proxy_add_x_forwarded_for
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_pass http://127.0.0.1:{{ nginx.backend_port }};
    }
}

{% for h in bop.domain_aliases %}
server {
    listen {{ h }}:80;
    server_name {{ h }};
    return 301 https://{{ nginx.vhost }}$request_uri;
}
{% endfor %}
