*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
{# https://serverfault.com/a/84981 To make it even harder to learn
 # about this, many common firewall books say "block ICMP" -- it's
 # clear their authors have never read an RFC or had to solve issues
 # surrounding such advice. It's bad advice to block all ICMP.
 #}
-A INPUT -p icmp -j ACCEPT
{% for d in network.private_devs %}
    -A INPUT -i {{ d }} -j ACCEPT
{% endfor %}
-A INPUT -i {{ network.inet_dev }} -p tcp -m state --state NEW -m tcp --match multiport --dports http,https -j ACCEPT
-A INPUT -i {{ network.inet_dev }} -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -i {{ network.inet_dev }} -m state --state INVALID -j REJECT --reject-with icmp-port-unreachable
-A INPUT -i {{ network.inet_dev }} -p tcp -m tcp --tcp-flags SYN,RST,ACK ACK -m state --state NEW -j REJECT --reject-with tcp-reset
-A INPUT -i {{ network.inet_dev }} -p tcp -m tcp ! --tcp-flags FIN,SYN,RST,ACK SYN -m state --state NEW -j REJECT --reject-with icmp-port-unreachable
-A INPUT -i {{ network.inet_dev }} -p tcp -m tcp --tcp-option 128 -j REJECT --reject-with icmp-port-unreachable

{% if network.public_ssh %}
    -A INPUT -i {{ network.inet_dev }} -p tcp -m tcp --dport ssh -m state --state NEW -m recent --set --name SSHPROBES --mask 255.255.255.255 --rsource
    {% for n in network.trusted_public_nets %}
        -A INPUT -i {{ network.inet_dev }} -s {{ n }} -p tcp -m tcp --dport 22 -m state --state NEW -m recent --remove --name SSHPROBES --mask 255.255.255.255 --rsource
    {% endfor %}
    -A INPUT -i {{ network.inet_dev }} -p tcp -m tcp --dport 22 -m state --state NEW -m recent --update --seconds 180 --hitcount 6 --name SSHPROBES --mask 255.255.255.255 --rsource -j DROP
    -A INPUT -i {{ network.inet_dev }} -p tcp -m state --state NEW -m tcp --match multiport --dport ssh -j ACCEPT
{% else %}
    {% for n in network.trusted_public_nets %}
        -A INPUT -i {{ network.inet_dev }} -s {{ n }} -p tcp -m tcp --dport ssh -j ACCEPT
    {% endfor %}
{% endif %}
-A INPUT -j REJECT --reject-with icmp-host-prohibited

{% if network.natted_nets %}
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
    -A FORWARD -i em2.132 -m state --state INVALID -j REJECT --reject-with icmp-port-unreachable
    -A FORWARD -i em2.132 -o em1 -m state --state RELATED,ESTABLISHED -j ACCEPT
    -A FORWARD -i em2.132 -j REJECT --reject-with icmp-host-prohibited
    COMMIT
    *nat
    :PREROUTING ACCEPT [0:0]
    :INPUT ACCEPT [0:0]
    :OUTPUT ACCEPT [0:0]
    :POSTROUTING ACCEPT [0:0]
    {# limit source addresses https://serverfault.com/a/511590 #}
    {% for n in network.natted_nets %}
        -A POSTROUTING -s 10.1.2.0/24 -o em2.132 -j MASQUERADE
    {% endfor %}
{% else %}
    -A FORWARD -j REJECT --reject-with icmp-host-prohibited
{% endif %}
COMMIT
