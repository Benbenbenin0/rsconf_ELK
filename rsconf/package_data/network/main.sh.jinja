#!/bin/bash

network_iptables() {
    if [[ $(systemctl is-active iptables 2>&1 || true) == active ]]; then
        # Just in case, make sure enabled
        systemctl enable iptables
        return
    fi
    # https://stackoverflow.com/a/24827438/3075806
    yum install -y iptables-services >& /dev/null || true
    systemctl enable iptables
    systemctl start iptables
}

network_main() {
    if [[ $(systemctl is-active NetworkManager) == active ]]; then
        systemctl stop NetworkManager
    fi
    systemctl disable NetworkManager >& /dev/null || true
    if [[ $(systemctl is-active firewalld) == active ]]; then
        systemctl stop firewalld
    fi
    systemctl disable firewalld >& /dev/null || true
    {% if network.iptables_enable %}
    network_iptables
    {% endif %}
    {% if network.public_ssh_port %}
    if rsconf_append /etc/ssh/sshd_config 'Port {{ network.public_ssh_port }}'; then
        systemctl restart sshd
    fi
    {% endif %}
}
