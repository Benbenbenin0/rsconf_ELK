#!/bin/bash
set -euo pipefail

run_acceptance() {
    PERLLIB='{{ btest.current_d }}' BCONF='{{ btest.bconf.acceptance }}' bivio test acceptance "$@"
}

run_args() {
    local t
    for t in "$@"; do
        case $t in
            *.btest)
                run_acceptance "$t"
                ;;
            *.bunit|*.t)
                run_unit "$t"
                ;;
            *)
                if [[ ! -d $t ]]; then
                    install_err "$t: unknown test type"
                fi
                if [[ $(shopt -s nullglob && cd "$t" && echo *.btest) ]]; then
                    run_acceptance "$t"
                else
                    run_unit "$t"
                fi
                ;;
        esac
    done
}

run_db_create() {
    # RealmFile is a proxy for the database
    local d='{{ btest.file_root }}/RealmFile'
    # 6.5 days in seconds
    if [[ -e $d ]] && (( $(stat -c %Y $d) + 561600 > $(date -u +%s) )); then
        return
    fi
    bivio sql init_dbms || true
    bivio sql write_bop_ddl_files
    bivio sql -force create_test_db
}

run_link_facade_files() {
    # link_facade_files should not create javascript
    bivio project link_facade_files \
        --Bivio::Ext::DBI.connection=Bivio::SQL::Connection::None \
        --Bivio::IO::Config.is_dev=0
    local facade
    for facade in '{{ btest.facade_local_file_root }}'/*; do
        if [[ ! -L $facade/plain/b ]]; then
            mkdir -p "$facade/plain"
            ln -s -r /usr/share/Bivio-bOP-javascript "$facade/plain/b"
        fi
    done
}

run_main() {
    if [[ $@ ]]; then
        run_args "$@"
        return $?
    fi
    cd '{{ btest.app_run_d }}'
    if [[ -e previous ]]; then
        # Some tests make directories read-only
        chmod -R u+rwX previous || true
        rm -rf previous
    fi
    mv '{{ btest.current_base }}' previous >& /dev/null || true
    mkdir '{{ btest.current_base }}'
    cd '{{ btest.current_base }}'
    # POSIT: container-bop/radiasoft-download.sh
    cp -a '{{ btest.app_source_d }}' .
    export PERLLIB='{{ btest.current_d }}' BCONF='{{ btest.bconf.unit }}'
    run_link_facade_files
    run_db_create
    run_unit '{{ btest.root_for_unit }}' || true
    run_acceptance '{{ btest.root_for_acceptance }}'|| true
}

run_unit() {
    PERLLIB='{{ btest.current_d }}' BCONF='{{ btest.bconf.unit }}' bivio test unit "$@"
}

run_main "$@"
