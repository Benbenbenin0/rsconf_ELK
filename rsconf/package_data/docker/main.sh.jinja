#!/bin/bash

docker_main() {
    local dir=/var/lib/docker
    if [[ -e $dir && $(type -t docker) != '' ]]; then
#TODO(robnagler) update docker rpm?
        install_info "$dir: exists, docker already installed"
        return
    fi
    rsconf_require base_users
#TODO(robnagler) need a list of repos and RPMs.
    # F27
    if rsconf_fedora_release_if 26; then
        # https://docs.docker.com/engine/installation/linux/docker-ce/fedora/#set-up-the-repository
        dnf -y install dnf-plugins-core
        dnf config-manager \
            --add-repo \
            https://download.docker.com/linux/fedora/docker-ce.repo
        # no release for 27 yet
        # https://github.com/docker/for-linux/issues/164#issuecomment-348173547
        install -m 700 -d /etc/dnf/vars
        echo 26 | install -m 600 /dev/stdin /etc/dnf/vars/docker_releasever
        perl -pi -e 's/\$releasever/\$docker_releasever/g' /etc/yum.repos.d/docker-ce.repo
    else
        yum-config-manager \
            --add-repo https://download.docker.com/linux/centos/docker-ce.repo
        yum makecache fast
        # yum-plugin-ovl required for overlay2 on centos7
        # https://github.com/docker-library/official-images/issues/1291
        rsconf_yum_install yum-plugin-ovl
    fi
#TODO(robnagler) how to update?
    rsconf_yum_install docker-ce
    {% if rsconf_db_channel == "dev" %}
        # Give vagrant user access in dev mode only
        usermod -aG docker vagrant
    {% endif %}
    systemctl start docker
    systemctl enable docker
}
