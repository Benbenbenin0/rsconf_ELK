#!/bin/bash

postfix_main() {
    rsconf_file_hash_save /etc/postfix/main.cf
    # https://codinfox.github.io/dev/2015/04/08/postfix-cannot-start/
    rsconf_yum_install procmail
    local lh=/etc/postfix/local-host-names
    if [[ ! -e $lh ]]; then
        rsconf_install_access 444 root root
        rsconf_install_file "$lh" /dev/null
    fi
    local x=(
        alias_maps=hash:/etc/aliases
        alias_database=hash:/etc/aliases
	inet_interfaces=all
	inet_protocols=ipv4
	'mailbox_command=/usr/bin/procmail -t -Y -a "$EXTENSION" -d "$USER"'
	recipient_delimiter=+
	'mydestination=$myhostname,localhost,'"$lh"
	local_recipient_maps=
	biff=no
	'smtpd_banner=$myhostname ESMTP'
	smtpd_delay_reject=no
        mynetworks=127.0.0.0/8
	smtpd_sender_restrictions=reject_unauth_pipelining,permit_mynetworks,reject_non_fqdn_sender,reject_unknown_sender_domain
	smtpd_recipient_restrictions=reject_unauth_pipelining,permit_mynetworks,reject_unauth_destination,reject_non_fqdn_recipient,reject_unknown_recipient_domain
	message_size_limit=50000000
	mailbox_size_limit=0
    )
    postconf -e "${x[@]}"
    rsconf_file_hash_check /etc/postfix/main.cf
}

postfix_setup_bop() {
    local master=/etc/postfix/master.cf
    local main=/etc/postfix/main.cf
    rsconf_file_hash_save "$main"
    postconf -e \
        'mailbox_transport=b-sendmail-http:unix' \
        'smtpd_timeout=${stress?12}${stress:300}' \
        'smtpd_hard_error_limit=${stress?1}${stress:20}' \
	'b-sendmail-http_destination_recipient_limit=1'
    rsconf_file_hash_check "$main"
    local rsconf_edit_no_change_res=0
    rsconf_edit "$master" \
        '^smtp.*200' 's{^smtp\s+inet.*}{smtp       inet  n       -       n       -       200       smtpd}'
    rsconf_edit "$master" \
        '^local.*8' 's{^local\s.*}{local     unix  -       n       n       -       8       local}'
    rsconf_append "$master" \
        'b-sendmail-http unix  -       n       n       -       2       pipe flags=DRhu user=nobody:nobody argv=/usr/bin/b-sendmail-http ${client_address} ${recipient} localhost.localdomain:80/_mail_receive/%s /bin/false any-param'

#TODO(robnagler)
# b-spamc-http
##!/bin/sh
## $Id: b-spamc-http,v 1.3 2013/05/19 22:35:51 nagler Exp $
#/usr/bin/spamc | /usr/bin/b-sendmail-http "$@"
}
