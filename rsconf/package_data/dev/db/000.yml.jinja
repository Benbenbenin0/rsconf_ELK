---
default:
  base_os:
    ip_forward: false
    volume_groups: {}
  base_users:
    add:
      - {{ user }}
    spec:
      joeblow:
        uid: 2002
        email: devnull@{{ master }}
      marysmith:
        uid: 2003
        email: blackhole@{{ master }}
        procmail_want_include: true
      {{ user }}:
        uid: {{ uid }}
        email: {{ user }}@{{ master }}
        want_shell: true
  bkp:
    archive_d: /srv/bkp/archive
    exclude:
      - /etc/selinux
    hosts:
      - {{ host }}
      - {{ master }}
    include:
      - /etc
      - /var/log
    log_dirs:
      - /var/log
      - /srv/*/log
    max_try: 6
    mirror_d: /srv/bkp/mirror
    # Time zones not accepted in systemd 219 (CentOS 7).
    # Times are in UTC. We may need to change the local time zone.
    on_calendar: "*-*-* 08:00:00"
    primary: {{ master }}
    secondaries: [ {{ all_host }} ]
    simple_mirrors:
      /srv/bkp/simple_mirror:
        - "{{ host }}:/etc/profile.d"
  bop:
    num_servers: 2
    secret:
      algorithm: DES
      magic: XYZ
    server_status_location: /bop-status
    vhost_common:
      # Only for test
      host_suffix: {{ host }}
  bop_timer:
    spec:
      petshop:
        first_one:
          on_calendar: "*-*-* 12:00:00"
          bash_script: |
            true

        second_thing:
          on_calendar: "*-*-1 00:00:00"
          bash_script: |
            echo doing that thing



  btest:
    client_host: {{ master }}
    email_user: {{ user }}
    apps: [ petshop ]
    on_calendar: "*-*-* 12:00:00"
  celery_sirepo:
    queues: "sequential,parallel"
  component:
    tls_crt_create: true
    tls_crt:
      dev_host:
        - alpha2.sirepo.com
        - beforeother.{{ host }}
        - bivio.biz.{{ host }}
        - jupyter.{{ host }}
        - m-petshop.{{ host }}
        - other.{{ host }}
        - owncloud.{{ host }}
        - petshop.{{ host }}
        - requiresecure.{{ host }}
        - sirepo.{{ host }}
        - {{ host }}
  db_bkp:
    max_copies: 2
    on_calendar: "*-*-* 06:30:00"
  docker:
    iptables: false
  docker_cache:
    host: ''
  docker_registry:
    host: {{ master }}
  github_bkp:
    docker_image: docker.io/radiasoft/beamsim
    exclude_re: ''
    # Relatively early, because it takes a long time (3 hours)
    on_calendar: "*-*-* 03:00:00"
    test_mode: True
  jupyterhub:
    admin_users: [ '{{ user }}' ]
    docker_image: docker.io/radiasoft/jupyterhub
    jupyter_docker_image: docker.io/radiasoft/beamsim-jupyter
    # github:
    #  client_id: ""
    #  client_secret: ""
    port: 7913
    vhosts:
      {{ host }}: jupyter.{{ host }}
  logrotate:
    verbose: true
    # sometime before bkp.on_calendar
    on_calendar: "*-*-* 07:30:00"
  mpi_worker:
    docker_image: docker.io/radiasoft/beamsim-jupyter
    guest_d: /home/vagrant/jupyter
    host_root_d: /srv/mpi_worker/user
    ssh_port: 8022
    slots_per_host: 2
  network:
    devices: {}
    trusted: {}
    public_ssh: False
  nfs_server:
    num_servers: 16
  nginx:
    worker_processes: 1
  owncloud:
    admin_user: admin
    db_name: owncloud
    db_prefix: oc_
    db_user: owncloud
    docker_image: docker.io/radiasoft/owncloud
    domain: owncloud.{{ host }}
    port: 7010
  owncloud_redis:
    docker_image: docker.io/radiasoft/redis
    port: 7012
  petshop:
    cookie_tag: PSD
    filter_out_of_office: true
    http_host: petshop.{{ host }}
    listen_base: 8114
    mail_host: petshop.{{ host }}
    nginx_aux_directives: ''
    num_servers: 4
    perl_rpm: perl-Bivio
    perl_root: Bivio::PetShop
    short_prefix: pet
    vhosts:
      # first vhost is default mail_host
      - domains:
          - petshop.{{ host }}
          - bprog.{{ host }}
        facade: petshop
        receive_mail: true
        nginx_aux_directives: |
          location /nginx_redirect/(.*) {
              return 301 $scheme://$host/$1;
          }

      - facade: beforeother
      - facade: m-petshop
      - facade: other
      - facade: requiresecure
  postfix:
    aliases:
      root: root@{{ master }}
      errors: errors@{{ master }}
      critical-errors: critical-errors@{{ master }}
    whitelist_senders:
      - poorly-configured-mailer.com
  postgresql:
    # https://wiki.postgresql.org/wiki/Tuning_Your_PostgreSQL_Server#effective_cache_size
    effective_cache_size: 244MB
    # https://wiki.postgresql.org/wiki/Tuning_Your_PostgreSQL_Server#shared_buffers
    # "If you have a system with 1GB or more of RAM, a reasonable
    # starting value for shared_buffers is 1/4 of the memory in your system."
    shared_buffers: 122MB
    auth_local_method: md5
  postgrey:
    port: 10023
    whitelist_recipients: []
  rabbitmq:
    docker_image: docker.io/radiasoft/rabbitmq
  rsconf: {}
  rsconf_db:
    #TODO(robnagler) POSIT dev/nginx/nginx.conf.jinja
    # defunct elvin_server https://en.wikipedia.org/wiki/Elvin
    http_host: http://{{ master }}:{{ port }}
    host_run_d: /srv
    root_u: root
    run_u: {{ user }}
    run_uid: {{ uid }}
  rs_mariadb:
    docker_image: docker.io/radiasoft/mariadb
    ip: 127.0.0.1
    port: 7011
  sirepo:
    docker_image: docker.io/radiasoft/sirepo
    oauth:
      github_key: ""
      github_secret: ""
    pkcli:
      service_processes: 1
      service_threads: 20
      service_port: 7000
  spamd: {}
  wordpress:
    docker_image: docker.io/radiasoft/wordpress

channel:
  dev:
    bop:
      apps: [ petshop ]
    mpi_worker:
      clusters:
        vagrant: [ {{ host }}, {{ worker5_host }}, {{ worker2_host }} ]
    network:
      trusted:
        # v*.radia.run private network
        10.10.10.0/24:
          gateway: 10.10.10.1
        # random network to test
        216.17.132.32/27:
          gateway: 216.17.132.62
          search: radia.run
          nameservers: [ 162.159.27.72, 162.159.24.39 ]
      untrusted: {}
    postgresql:
      auth_local_method: trust
    sirepo:
      celery_tasks:
        celeryd_concurrency: 1
        broker_url: "amqp://guest@rabbitmq.{{ host }}//"
      comsol_register:
        mail_server: {{ master }}
        mail_username: comsol@{{ master }}
        mail_password: somepass
      mpi_cores: 4
      vhost: sirepo.{{ host }}
    wordpress:
      vhosts:
        wp1.{{ host }}:
          port: 7101
          db_name: wp1
          db_user: wp1user

host:
  dev:
    {{ worker2_host }}:
      docker:
        tls_host: {{ worker2_host }}
      nfs_client:
        mounts:
          {{ master }}:
            - /srv/mpi_worker/user
      rsconf_db:
        components: [ mpi_worker ]
    {{ master }}:
      base_os:
        volume_groups:
          docker:
            logical_volumes:
              docker:
                #POSIT: download/installers/vagrant-dev:config.persistent_storage.size=102400
                gigabytes: 99
                mount_d: /srv/docker
      base_users:
        add:
          - joeblow
          - marysmith
        spec:
          joeblow:
            want_shell: true
      docker:
        tls_host: {{ master }}
      jupyterhub:
        pools:
          default:
            users: [ ]
            servers_per_host: 2
            mem_limit: "1G"
            cpu_limit: 0.5
            hosts: [ {{ master }} ]
          private:
            users: [ vagrant ]
            servers_per_host: 1
            hosts: [ {{ worker2_host }}, {{ worker5_host }} ]
        vhosts:
          {{ master }}: jupyter.{{ master }}
      nfs_server:
        exports:
          /srv/mpi_worker/user: [ 10.10.10.0/24 ]
      postfix:
        aliases:
          RSCONF_DB_REPLACE:
            # root and errors gets delivered locally so we replace
            blackhole: /dev/null
        virtual_aliases:
          wp1.{{ master }}:
            vagrant: vagrant
      rsconf_db:
        #TODO(robnagler) need to edit this to just rsconf to bootstrap
        #components: [ rsconf, bkp, docker_registry ]
        # jupyterhub_proxy, btest, github_bkp, dovecot ]
        components: [ rsconf, docker_registry, nfs_server, jupyterhub, jupyterhub_proxy ]
        # components: [ rsconf, docker_registry, btest ]
    {{ host }}:
      docker:
        tls_host: {{ host }}
      jupyterhub:
        vhosts:
          {{ host }}: jupyter.{{ host }}
      nginx:
        redirects:
          - host_or_uri: www.google.com
            server_names:
              - redirect1.{{ host }}
              - redirect2.{{ host }}
          - host_or_uri: https://beta.sirepo.com/warp
            server_names:
              - redirect3.{{ host }}
            want_www: true
      nfs_client:
        mounts:
          {{ master }}:
            - /srv/mpi_worker/user
      nfs_server:
        exports:
          /srv/sirepo/db/user: [ 10.10.10.0/24 ]
      rsconf_db:
#        components: [ bop ]
#        components: [ jupyterhub, jupyterhub_proxy ]
#        components: [ rabbitmq, celery_sirepo, sirepo, nfs_server ]
        components: [ nfs_client, nfs_server, mpi_worker ]
#      sirepo:
#        docker_hosts: [ {{ host }}, {{ worker5_host }} ]
    {{ worker5_host }}:
      docker:
        tls_host: {{ worker5_host }}
      nfs_client:
        mounts:
          {{ master }}:
            - /srv/mpi_worker/user
      postfix:
        smart_host: {{ master }}
      rsconf_db:
        components: [ mpi_worker ]
    # This host never installed, just for testing build
    {{ all_host }}:
      base_users:
        add:
          - joeblow
          - marysmith
      bkp:
        on_calendar: "*-*-1 18:00:00"
        secondary_copy_d: /bkp_copy
        secondary_setup_f: {{ root_d }}/etc/secondary_setup.sh
      jupyterhub:
        github:
          client_id: xyzzy
          client_secret: big-secret
        vhosts:
          {{ all_host }}: jupyter.{{ all_host }}
      network:
        public_ssh: true
        natted_nets: [ 10.10.10.0/24 ]
        devices:
          em1:
            ip: 10.10.10.5
            is_natted: True
          em2:
            ip: 216.17.132.33
#          eth0:
#            ip: 104.237.137.251
        trusted:
          104.237.137.251/32: {}
          216.17.132.32/27:
            # Switch to CloudFlare (test RSCONF_DB_REPLACE)
            nameservers:
              RSCONF_DB_REPLACE: [ 1.1.1.1, 1.0.0.1 ]
        untrusted:
          104.237.137.0/24:
            gateway: 104.237.137.1
            nameservers: [ 1.0.0.1 ]
            search: radiasoft.net
      nfs_client:
        mounts:
          {{ master }}:
            - /srv/sirepo/db/users
      nfs_server:
        num_servers: 64
        exports:
          /exports/foo: [ 10.10.10.0/24, localhost ]
      postfix:
        # if you do not set this, you'll get to test the SLD matching:
        # fnl1i.bivio.biz: reverse dns for 216.17.132.33 does not match SLD of v5.radia.run
        myhostname: '{{ master }}'
      rsconf_db:
        components:
          # order matters on startup, because not all dependencies
          # are expressed in the require_component or imports,
          # e.g. celery_sirepo must start before sirepo
          - nfs_client
          - nfs_server
          - rabbitmq
          - bkp
          - comsol
          - celery_sirepo
          - sirepo
          - bop
          - btest
          - dovecot
          - jupyterhub
          - jupyterhub_proxy
          - owncloud
          - github_bkp
          - wordpress
# testing named needs build-perl-rpms.sh
#          - bivio_named

#Local Variables:
#mode:yaml
#End:
