# -*-python-*-
import binascii
import grp
import jupyter_client.localinterfaces
import os
import os.path
import pwd

c.Authenticator.admin_users = set([{{ jupyterhub.admin_users_str }}])
{% if 'whitelist_users_str' in jupyterhub %}
c.Authenticator.whitelist = set([{{ jupyterhub.whitelist_users_str }}])
{% endif %}
{% if 'github' in jupyterhub %}
import oauthenticator
c.JupyterHub.authenticator_class = oauthenticator.GitHubOAuthenticator
c.GitHubOAuthenticator.client_id = '{{ jupyterhub.github.client_id }}'
c.GitHubOAuthenticator.client_secret = '{{ jupyterhub.github.client_secret }}'
c.GitHubOAuthenticator.oauth_callback_url = 'https://{{ jupyterhub.vhost }}/hub/oauth_callback'
{% else %}
assert '{{ rsconf_db.channel }}' == 'dev', \
    'development only; all other channels must use GitHubOAuthenticator'
import jupyterhub.auth
class _Auth(jupyterhub.auth.Authenticator):
    async def authenticate(self, handler, data):
        if data['password'] == '{{ jupyterhub.mock_password }}':
            return data['username']
        return None
c.JupyterHub.authenticator_class = _Auth
{% endif %}
c.JupyterHub.cleanup_servers = False
c.JupyterHub.confirm_no_ssl = True
c.JupyterHub.cookie_secret = binascii.a2b_hex('{{ jupyterhub.cookie_secret_hex }}')
c.JupyterHub.hub_ip = jupyter_client.localinterfaces.public_ips()[0]
c.JupyterHub.ip = '0.0.0.0'
c.JupyterHub.port = {{ jupyterhub.port }}
c.JupyterHub.template_paths = ['{{ jupyterhub.template_d }}']
c.JupyterHub.template_vars = {{ jupyterhub.template_vars }}
c.JupyterHub.upgrade_db = True
c.ConfigurableHTTPProxy.auth_token = '{{ jupyterhub.proxy_auth_token }}'
c.DockerSpawner.http_timeout = {{ jupyterhub.http_timeout }}
# https://github.com/radiasoft/rsconf/issues/54
c.DockerSpawner.image_whitelist = []
c.DockerSpawner.image = '{{ jupyterhub.jupyter_docker_image }}'
c.DockerSpawner.remove = True
c.DockerSpawner.use_internal_ip = True
{% if 'rsdockerspawner_cfg' in jupyterhub %}
c.DockerSpawner.network_name = 'host'
c.RSDockerSpawner.cfg = '''{{ jupyterhub.rsdockerspawner_cfg }}'''
from rsdockerspawner import rsdockerspawner
c.JupyterHub.spawner_class = rsdockerspawner.RSDockerSpawner
{% else %}
from dockerspawner import dockerspawner
class _Spawner(dockerspawner.DockerSpawner):
    def _volumes_to_binds(self, *args, **kwargs):
        binds = super(_Spawner, self)._volumes_to_binds(*args, **kwargs)
        for v in binds:
            while not os.path.exists(v):
                os.mkdir(v)
                uid = pwd.getpwnam('{{ jupyterhub.jupyter_run_u }}').pw_uid
                gid = grp.getgrnam('{{ jupyterhub.jupyter_run_u }}').gr_gid
                os.chown(v, uid, gid)
                v = os.path.dirname(v)
        return binds
c.JupyterHub.spawner_class = _Spawner
c.DockerSpawner.volumes = {
    '{{ jupyterhub.user_d }}/{username}': {
        # POSIT: notebook_dir in
        # radiasoft/container-beamsim-jupyter/container-conf/build.sh
        # parameterize anyway, because matches above
        'bind': '{{ jupyterhub.home_d }}/jupyter',
    },
}
{% endif %}
#c.Application.log_level = 'DEBUG'
# Might not want this, but for now it's useful to see everything
#c.JupyterHub.debug_db = True
#c.ConfigurableHTTPProxy.debug = True
#c.JupyterHub.log_level = 'DEBUG'
#c.LocalProcessSpawner.debug = True
#c.Spawner.debug = True
